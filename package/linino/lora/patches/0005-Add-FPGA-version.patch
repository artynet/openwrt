From ee8d99a8eae5abf39aa80d4bad9418897c6547f7 Mon Sep 17 00:00:00 2001
From: Arturo Rinaldi <arty.net2@gmail.com>
Date: Fri, 3 Feb 2017 13:57:49 +0100
Subject: [PATCH 05/19] Add FPGA version

---
 libloragw/src/loragw_reg.c       | 2 +-
 libloragw/src/loragw_spi-stm32.c | 4 +++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/libloragw/src/loragw_reg.c b/libloragw/src/loragw_reg.c
index 7e396bc..501f8e4 100644
--- a/libloragw/src/loragw_reg.c
+++ b/libloragw/src/loragw_reg.c
@@ -48,7 +48,7 @@ Maintainer: Sylvain Miermont
 #define PAGE_ADDR        0x00
 #define PAGE_MASK        0x03
 
-const uint8_t FPGA_VERSION[] = { 31, 33 }; /* several versions could be supported */
+const uint8_t FPGA_VERSION[] = { 27, 103 }; /* several versions could be supported */
 
 /*
 auto generated register mapping for C code : 11-Jul-2013 13:20:40
diff --git a/libloragw/src/loragw_spi-stm32.c b/libloragw/src/loragw_spi-stm32.c
index 686941e..3e28f23 100644
--- a/libloragw/src/loragw_spi-stm32.c
+++ b/libloragw/src/loragw_spi-stm32.c
@@ -184,7 +184,9 @@ int lgw_spi_r(void *spi_target, uint8_t spi_mux_mode, uint8_t spi_mux_target, ui
     }
     
     nw = write(spi_device, &out_buf[0], command_size);
+    DEBUG_PRINTF("INFO: written n.bytes %d\n", nw);
     nr = read(spi_device, &in_buf[0], command_size);
+    DEBUG_PRINTF("INFO: read n.bytese %d\n", nr);
 
     /* determine return code */
     if ((nw != (int)command_size) || (nr != (int)command_size)) {
@@ -192,7 +194,7 @@ int lgw_spi_r(void *spi_target, uint8_t spi_mux_mode, uint8_t spi_mux_target, ui
         return LGW_SPI_ERROR;
     } else {
         DEBUG_MSG("Note: SPI read success\n");
-        *data = in_buf[command_size - 1];
+        *data = in_buf[command_size - 2];
         return LGW_SPI_SUCCESS;
     }
 }
-- 
2.11.0

